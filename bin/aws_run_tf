#!/bin/bash

if [[ -z $AWS_PROFILE ]];
then
  echo "Missing AWS_PROFILE env var"
  exit 1
fi

profile=${AWS_PROFILE:-lab}

# AWS_PROFILE being set causes terraform grief
unset AWS_PROFILE

eval "$(get_aws_creds $profile)" &> /dev/null
if [[ $? -ne 0 ]];
then
    echo "Failed to get creds for $profile - exiting"
    exit 1
fi

export VAULT_TLS_SERVER_NAME=$(yq '.config.base_url' ~/.creds.yaml | awk '{print $1}' | cut -d: -f1-2 | cut -d\/ -f3)
export VAULT_ADDR=$VAULT_TLS_SERVER_NAME
export VAULT_TOKEN=$(yq '.config.token' ~/.creds.yaml | awk '{print $1}' | tr -d "\"")

if [[ -z "$VAULT_TLS_SERVER_NAME" ]];
then
  echo "VAULT_TLS_SERVER_NAME appears empty"
fi

if [[ -z "$VAULT_TOKEN" ]];
then
  echo "VAULT_TOKEN appears empty"
fi

terraform $@
