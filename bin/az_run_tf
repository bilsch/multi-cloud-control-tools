#!/bin/bash

if [[ -z $ARM_SUBSCRIPTION_ID ]];
then
  echo "Missing ARM_SUBSCRIPTION_ID env var"
  exit 1
fi

export VAULT_ADDR=$(yq '.config.base_url' ~/.creds.yaml | awk '{print $1}')
export VAULT_TOKEN=$(yq '.config.token' ~/.creds.yaml | awk '{print $1}')

if [[ -z "$VAULT_ADDR" ]];
then
  echo "VAULT_ADDR appears empty"
fi

if [[ -z "$VAULT_TOKEN" ]];
then
  echo "VAULT_TOKEN appears empty"
fi

echo "fetching creds from vault"
eval "$(get_az_creds)" &> /dev/null
if [[ $? -ne 0 ]];
then
    echo "Failed to get creds for $ARM_SUBSCRIPTION_ID - exiting"
    exit 1
fi

terraform $@
